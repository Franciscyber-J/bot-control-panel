<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controlo de Bots</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%2300FFFF' d='M20 10 H80 V20 H30 V80 H20 V10 Z M40 30 H90 V40 H50 V90 H40 V30 Z' /%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
</head>

<body>
    <div class="container">
        <header class="panel-header">
            <h1>Painel de Controlo de Bots</h1>
            <div class="header-controls">
                <a href="https://habiticongyn.com/tutorial-telegram/" target="_blank" class="action-btn">
                    <i data-feather="book-open" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>
                    <span>Abrir Tutorial</span>
                </a>
                <button id="copy-tutorial-link-btn" class="action-btn">
                    <i data-feather="copy" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>
                    <span>Copiar Link</span>
                </button>
                <button id="add-bot-btn" class="action-btn primary">Adicionar Novo Bot</button>
                <button id="logout-btn" class="action-btn">Logout</button>
            </div>
        </header>

        <main id="bot-list" class="bot-list-grid">
        </main>

        <footer class="panel-footer">
            <p>Status da Conexão: <span id="connection-status">Conectando...</span></p>
        </footer>
    </div>

    <div id="add-bot-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Adicionar Novo Bot a partir do GitHub</h2>
            <form id="add-bot-form">
                <p class="modal-description">O painel irá clonar o repositório, enviar o seu ficheiro .env, instalar as dependências e iniciar o bot automaticamente.</p>
                <div class="form-group">
                    <label for="bot-name-add">1. Dê um nome ao processo do bot</label>
                    <input type="text" id="bot-name-add" placeholder="ex: meu-novo-bot" required>
                </div>
                <div class="form-group">
                    <label for="bot-git-url-add">2. Insira a URL do Repositório Git (HTTPS)</label>
                    <input type="url" id="bot-git-url-add" placeholder="https://github.com/usuario/meu-bot.git" required>
                </div>
                <div class="form-group">
                    <label>3. Anexe o ficheiro .env (Obrigatório)</label>
                    <button type="button" class="action-btn" id="upload-env-btn-add">
                        <i data-feather="upload-cloud" style="width: 16px; margin-right: 0.5rem;"></i>
                        <span>Selecionar Ficheiro .env</span>
                    </button>
                    <input type="file" id="bot-env-file-add" accept=".env" style="display: none;">
                    <span id="env-file-status" class="file-status">Nenhum ficheiro selecionado.</span>
                </div>
                <div class="modal-actions">
                    <button type="submit" id="add-bot-submit-btn" class="action-btn primary" disabled>Adicionar e Iniciar</button>
                    <button type="button" class="action-btn close-modal-btn danger">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="update-source-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Atualizar Fonte do Bot</h2>
            <form id="update-source-form">
                <p class="modal-description">Insira o URL do repositório GitHub para fazer o deploy. Isto irá substituir a fonte remota atual e puxar a versão mais recente.</p>
                <div class="form-group">
                    <label for="bot-git-url">URL do Repositório Git (HTTPS)</label>
                    <input type="url" id="bot-git-url" placeholder="https://github.com/usuario/repositorio.git" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="action-btn primary">Confirmar e Fazer Deploy</button>
                    <button type="button" class="action-btn close-modal-btn danger">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="log-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content modal-output">
            <h2 id="log-modal-title">Logs do Bot</h2>
            <div class="log-container">
                <pre><code id="log-content"></code></pre>
            </div>
            <div class="modal-actions">
                <button type="button" class="action-btn close-modal-btn">Fechar</button>
            </div>
        </div>
    </div>

    <div id="update-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content modal-output">
            <h2 id="update-modal-title">Resultado do Deploy</h2>
            <div class="log-container">
                <pre><code id="update-content"></code></pre>
            </div>
            <div class="modal-actions">
                <button type="button" class="action-btn close-modal-btn">Fechar</button>
            </div>
        </div>
    </div>

    <div id="notification-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="notification-title">Aviso</h2>
            <p id="notification-message" style="white-space: pre-wrap; text-align: left; background-color: #010409; padding: 1rem; border-radius: 6px;"></p>
            <div class="modal-actions">
                <button type="button" class="action-btn close-modal-btn">OK</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="confirmation-title">Confirmar Ação</h2>
            <p id="confirmation-message"></p>
            <div class="modal-actions">
                <button type="button" id="confirm-btn-yes" class="action-btn primary">Confirmar</button>
                <button type="button" id="confirm-btn-no" class="action-btn danger">Cancelar</button>
            </div>
        </div>
    </div>

    <input type="file" id="env-file-input" style="display: none;" accept=".env">

    <div id="notification-manager-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="notification-manager-title">Gerir Notificações</h2>
            <div id="notification-list-container" class="form-group"></div>
            <div class="modal-actions">
                <button type="button" class="action-btn primary" id="add-new-notification-btn">Adicionar Nova Notificação</button>
                <button type="button" class="action-btn close-modal-btn">Fechar</button>
            </div>
        </div>
    </div>

    <div id="edit-notification-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2 id="edit-notification-title">Adicionar/Editar Notificação</h2>
            <form id="edit-notification-form">
                <input type="hidden" id="notification-id">
                <div class="form-group">
                    <label for="notification-name">Nome do Usuário / Canal (para sua identificação)</label>
                    <input type="text" id="notification-name" required>
                </div>
                <div class="form-group">
                    <label for="notification-purpose">
                        <div class="label-with-tooltip">
                            <span>Finalidade (Identificador usado no código)</span>
                            <div class="tooltip">
                                <i data-feather="help-circle"></i>
                                <span class="tooltip-text">Este é o identificador único que o seu código usa para chamar esta notificação. O valor aqui deve ser exatamente igual ao que está na função `sendNotification('identificador_aqui', ...)` no seu script.</span>
                            </div>
                        </div>
                    </label>
                    <input type="text" id="notification-purpose" placeholder="ex: alerta_novo_lead" required>
                </div>
                <div class="form-group">
                    <label for="notification-token">Token do Bot do Telegram</label>
                    <div class="input-with-icon">
                        <input type="password" id="notification-token" required autocomplete="new-password">
                        <span class="input-icon-toggle" id="toggle-token-visibility">
                            <i data-feather="eye" class="icon-eye"></i>
                            <i data-feather="eye-off" class="icon-eye-off" style="display: none;"></i>
                        </span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="notification-chat-id">Chat ID do Telegram</label>
                    <input type="text" id="notification-chat-id" required>
                </div>
                <p class="modal-description" style="margin-top: -1rem; margin-bottom: 2rem;">
                    Nunca partilhe os seus tokens. Eles serão guardados de forma segura no ficheiro .env do seu bot no servidor.
                </p>
                <div class="modal-actions">
                    <button type="submit" class="action-btn primary">Salvar e Reiniciar Bot</button>
                    <button type="button" class="action-btn close-modal-btn danger">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // SCRIPT COMPLETO E CORRIGIDO - V11 (BOTÕES DE FECHAR CORRIGIDOS)

        let currentLogSocket = null;
        let currentBotForNotifications = null;
        let newBotEnvContent = null;
        let dashboardSocket = null;

        function setLoading(button, isLoading, loadingText = 'Aguarde...') {
            if (!button) return;
            const originalContent = button.dataset.originalContent;
            if (isLoading) {
                if (!originalContent) {
                    button.dataset.originalContent = button.innerHTML;
                }
                button.disabled = true;
                button.innerHTML = `<span class="loading-spinner"></span>${loadingText}`;
            } else {
                if (originalContent) {
                    button.innerHTML = originalContent;
                    button.dataset.originalContent = '';
                }
                button.disabled = false;
            }
        }

        function showNotification(title, message, type = 'info') {
            const modal = document.getElementById('notification-modal');
            modal.querySelector('#notification-title').textContent = title;
            modal.querySelector('#notification-message').textContent = message;
            modal.style.display = 'flex';
        }

        function showConfirmation(title, message, button) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmation-modal');
                modal.querySelector('#confirmation-title').textContent = title;
                modal.querySelector('#confirmation-message').innerHTML = message.replace(/\n/g, '<br>');
                modal.style.display = 'flex';
                
                const btnYes = document.getElementById('confirm-btn-yes');
                const btnNo = document.getElementById('confirm-btn-no');

                const resolveAndCleanup = (value) => {
                    modal.style.display = 'none';
                    if (button && !value) setLoading(button, false);
                    btnYes.onclick = null;
                    btnNo.onclick = null;
                    resolve(value);
                };

                btnYes.onclick = () => resolveAndCleanup(true);
                btnNo.onclick = () => resolveAndCleanup(false);
            });
        }

        async function fetchWithAuth(url, options = {}) {
            const response = await fetch(url, options);
            if (response.status === 401) {
                window.location.href = '/';
                throw new Error('Não autorizado');
            }
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'Falha de conexão. Servidor indisponível.' }));
                throw new Error(errorData.error);
            }
            return response.json();
        }
        
        async function manageBot(name, action, button) {
            setLoading(button, true, action.charAt(0).toUpperCase() + action.slice(1) + 'ndo...');
            const actionPt = { start: 'INICIAR', restart: 'REINICIAR', stop: 'PARAR' };
            const confirmed = await showConfirmation('Confirmar Ação', `Confirmar execução do comando?\n> ${actionPt[action]} ${name}`, button);
            if (!confirmed) return;

            setLoading(button, true, action.charAt(0).toUpperCase() + action.slice(1) + 'ndo...');
            try {
                const result = await fetchWithAuth('/api/bots/manage', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, action })
                });
                showNotification('Sucesso', result.message);
            } catch (error) {
                showNotification('Falha na Execução', `ERRO: ${error.message}`, 'error');
            } finally {
                setLoading(button, false);
            }
        }

        async function deleteBot(name, button) {
            setLoading(button, true, 'Excluindo...');
            const confirmed = await showConfirmation('Confirmar Exclusão', `Tem a certeza que deseja PARAR e EXCLUIR o bot "${name}"?\nEsta ação não pode ser desfeita.`, button);
            if (!confirmed) return;
            
            setLoading(button, true, 'Excluindo...');
            try {
                const result = await fetchWithAuth(`/api/bots/delete/${name}`, { method: 'DELETE' });
                showNotification('Sucesso', result.message);
            } catch (error) {
                showNotification('Falha ao Excluir', `ERRO: ${error.message}`, 'error');
                setLoading(button, false);
            }
        }

        async function showLogs(name, initialMessage = null) {
            const logModal = document.getElementById('log-modal');
            const logModalTitle = document.getElementById('log-modal-title');
            const logContent = document.getElementById('log-content');
            const logContainer = logContent.parentElement;
            
            logModalTitle.textContent = `Logs de ${name}`;
            logContent.textContent = initialMessage ? `${initialMessage}\n\n` : 'A carregar histórico de logs...\n';
            logModal.style.display = 'flex';
            logContainer.scrollTop = logContainer.scrollHeight;

            if (!initialMessage) {
                try {
                    const result = await fetchWithAuth(`/api/bots/logs/${name}`);
                    logContent.textContent = result.logs ? result.logs + '\n--- Logs em tempo real ---\n' : '--- Logs em tempo real ---\n';
                } catch (error) {
                    logContent.textContent = `ERRO AO CARREGAR HISTÓRICO: ${error.message}\n`;
                }
            }
            logContainer.scrollTop = logContainer.scrollHeight;
            
            if (currentLogSocket) currentLogSocket.close();
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/logs/${name}`;
            currentLogSocket = new WebSocket(wsUrl);

            currentLogSocket.onopen = () => { logModalTitle.textContent = `Logs de ${name} (Conectado)`; };
            currentLogSocket.onmessage = (event) => { logContent.textContent += event.data; logContainer.scrollTop = logContainer.scrollHeight; };
            currentLogSocket.onerror = () => { logContent.textContent += '\n--- ERRO NA CONEXÃO WEBSOCKET DE LOGS ---\n'; };
            currentLogSocket.onclose = () => { logModalTitle.textContent = `Logs de ${name} (Desconectado)`; };
        }

        function showUpdateModal(name) {
            const modal = document.getElementById('update-source-modal');
            const form = document.getElementById('update-source-form');
            const gitUrlInput = document.getElementById('bot-git-url');
            modal.style.display = 'flex';
            gitUrlInput.value = '';
            
            form.onsubmit = async (event) => {
                event.preventDefault();

                const submitButton = form.querySelector('button[type="submit"]');
                setLoading(submitButton, true, 'A fazer deploy...');
                
                const gitUrl = gitUrlInput.value;
                modal.style.display = 'none';
                
                await updateBot(name, gitUrl);
                setLoading(submitButton, false);
            };
        }

        async function updateBot(name, gitUrl) {
            const modal = document.getElementById('update-modal');
            const title = document.getElementById('update-modal-title');
            const content = document.getElementById('update-content');
            modal.style.display = 'flex';
            title.textContent = `Deploy do Bot: ${name}`;
            content.textContent = `A iniciar processo de deploy a partir de: ${gitUrl}`;

            try {
                const result = await fetchWithAuth(`/api/bots/update/${name}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ gitUrl })
                });
                content.textContent = result.output;
            } catch (error) {
                content.textContent = `ERRO NO DEPLOY: ${error.message}`;
            }
        }

        async function uploadEnvFile(name) {
            const fileInput = document.getElementById('env-file-input');
            fileInput.onchange = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const confirmed = await showConfirmation('Confirmar Upload', `Tem a certeza que deseja enviar o ficheiro "${file.name}" para o bot "${name}"?\nIsto irá substituir o ficheiro .env existente e reiniciar o bot.`);
                if (!confirmed) { fileInput.value = ''; return; }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const result = await fetchWithAuth(`/api/bots/env/${name}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: e.target.result })
                        });
                        showNotification('Sucesso', result.message);
                    } catch (error) {
                        showNotification('Falha no Upload', `ERRO: ${error.message}`, 'error');
                    } finally {
                        fileInput.value = '';
                    }
                };
                reader.readAsText(file);
            };
            fileInput.click();
        }
        
        async function resetBotSession(botName, button) {
            setLoading(button, true, 'A reiniciar...');
            const confirmed = await showConfirmation(
                'Adicionar Novo Número', 
                `Tem a certeza que deseja desconectar o aparelho atual do bot <b>${botName}</b>?\n\nEsta ação irá apagar os dados da sessão guardada, forçar a geração de um novo QR Code e reiniciar o bot.`,
                button
            );
            if (!confirmed) return;

            setLoading(button, true, 'A reiniciar...');
            showLogs(botName, `A iniciar o processo de reset...\n\n`);

            if (dashboardSocket && dashboardSocket.readyState === WebSocket.OPEN) {
                dashboardSocket.send(JSON.stringify({
                    type: 'resetSession',
                    data: { name: botName }
                }));
            } else {
                showNotification('Erro', 'A conexão com o painel não está ativa. Por favor, atualize a página.', 'error');
                setLoading(button, false);
            }
            setTimeout(() => setLoading(button, false), 20000);
        }
        
        async function showNotificationManager(botName) {
            currentBotForNotifications = { name: botName };
            const modal = document.getElementById('notification-manager-modal');
            const title = document.getElementById('notification-manager-title');
            const container = document.getElementById('notification-list-container');
            title.textContent = `Gerir Notificações de "${botName}"`;
            container.innerHTML = '<div class="loading-spinner" style="margin: 2rem auto;"></div>';
            modal.style.display = 'flex';

            try {
                const url = `/api/bots/notifications/${encodeURIComponent(botName)}`;
                const data = await fetchWithAuth(url);
                renderNotificationList(data.notifications, data.notifierInjected, data.foundPurposes);
            } catch (error) {
                container.innerHTML = `<p style="color: var(--red);">ERRO: ${error.message}</p>`;
            }
        }

        function renderNotificationList(notifications = [], notifierInjected, foundPurposes = []) {
            const container = document.getElementById('notification-list-container');
            let html = '';

            if (foundPurposes.length > 0) {
                html += `<div class="info-message"><strong>Finalidades encontradas no código:</strong><br><small>Use um destes nomes no campo "Finalidade" para garantir o funcionamento.</small><div class="purpose-list">`;
                foundPurposes.forEach(purpose => {
                    html += `<code>${purpose}</code>`;
                });
                html += '</div></div>';
            }

            if (notifications.length === 0) {
                html += '<p class="info-message">Nenhuma notificação do Telegram configurada para este bot.</p>';
            } else {
                html += notifications.map(notif => {
                    const notifDataForEdit = JSON.stringify(notif).replace(/'/g, "&apos;");
                    return `
                    <div class="notification-item">
                        <div>
                            <strong>${notif.name}</strong><br>
                            <small>Finalidade: <code>${notif.purpose || 'Não definida'}</code> | Chat ID: ${notif.chatId}</small>
                        </div>
                        <div class="notification-item-actions">
                            <button class="action-btn-footer test-notification-btn" 
                                    data-name="${notif.name.replace(/"/g, '&quot;')}" 
                                    data-token="${notif.token}" 
                                    data-chat-id="${notif.chatId}" 
                                    title="Enviar Teste">
                                <i data-feather="send"></i> Testar
                            </button>
                            <button class="action-btn-footer edit-notification-btn" 
                                    data-notification='${notifDataForEdit}' 
                                    title="Editar">
                                <i data-feather="edit"></i> Editar
                            </button>
                            <button class="action-btn-footer danger delete-notification-btn" 
                                    data-notification-id="${notif.id}"
                                    data-notification-name="${notif.name.replace(/"/g, '&quot;')}"
                                    title="Remover">
                                <i data-feather="trash-2"></i> Remover
                            </button>
                        </div>
                    </div>`;
                }).join('');
            }
            
            if (!notifierInjected && (notifications.length > 0 || foundPurposes.length > 0)) {
                html += `
                    <div class="info-message warning">
                        <p><strong>Ação Necessária:</strong> O código para usar as notificações ainda não foi implementado no script principal deste bot.</p>
                        <button class="action-btn primary" onclick="injectNotifierCode(this)">
                            <i data-feather="tool"></i>Aplicar Correção Automática
                        </button>
                    </div>`;
            }
            container.innerHTML = html;
            feather.replace();
        }

        function showEditNotificationModal(notification = null) {
            const modal = document.getElementById('edit-notification-modal');
            const form = document.getElementById('edit-notification-form');
            form.reset();
            
            if (notification) {
                document.getElementById('edit-notification-title').textContent = "Editar Notificação";
                document.getElementById('notification-id').value = notification.id;
                document.getElementById('notification-name').value = notification.name;
                document.getElementById('notification-purpose').value = notification.purpose || '';
                document.getElementById('notification-token').value = notification.token;
                document.getElementById('notification-chat-id').value = notification.chatId;
            } else {
                document.getElementById('edit-notification-title').textContent = "Adicionar Nova Notificação";
                document.getElementById('notification-id').value = Date.now();
            }
            modal.style.display = 'flex';
            feather.replace();
        }

        async function testNotification(name, token, chatId, button) {
            setLoading(button, true, 'Testando...');
            if (!token || !chatId) {
                showNotification('Falha no Teste', 'ERRO: Token ou Chat ID estão em branco no cliente. Verifique os dados.', 'error');
                setLoading(button, false);
                return;
            }

            try {
                const result = await fetchWithAuth('/api/bots/notifications/test', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ 
                        token: token, 
                        chatId: chatId, 
                        message: `Olá! Esta é uma mensagem de teste enviada do seu Painel de Controlo para a notificação "${name}".` 
                    })
                });
                showNotification('Sucesso', result.message);
            } catch (error) {
                showNotification('Falha no Teste', `ERRO: ${error.message}`, 'error');
            } finally {
                setLoading(button, false);
            }
        }

        async function deleteNotification(notificationId, notificationName, button) {
            setLoading(button, true, 'Removendo...');
            if (!currentBotForNotifications) return;
            const { name: botName } = currentBotForNotifications;

            const confirmed = await showConfirmation('Confirmar Remoção', `Tem a certeza que deseja remover a notificação "${notificationName}"?`, button);
            if (!confirmed) return;
            
            setLoading(button, true, 'Removendo...');
            try {
                const url = `/api/bots/notifications/${encodeURIComponent(botName)}/${encodeURIComponent(notificationId)}`;
                const result = await fetchWithAuth(url, { method: 'DELETE' });
                showNotification('Sucesso', result.message);
                showNotificationManager(botName);
            } catch (error) {
                showNotification('Falha ao Remover', `ERRO: ${error.message}`, 'error');
                setLoading(button, false);
            }
        }

        async function injectNotifierCode(button) {
            setLoading(button, true, 'Aplicando...');
            if (!currentBotForNotifications) return;
            const { name } = currentBotForNotifications;

            const confirmed = await showConfirmation('Confirmar Correção Automática', `Isto irá adicionar a linha de código necessária no topo do ficheiro principal do bot <b>${name}</b> e reiniciá-lo.\n\nDeseja continuar?`, button);
            if (!confirmed) return;
            
            setLoading(button, true, 'Aplicando...');
            try {
                const result = await fetchWithAuth(`/api/bots/inject-notifier/${name}`, { method: 'POST' });
                showNotification('Sucesso', result.message);
            } catch (error) {
                showNotification('Falha ao Aplicar Correção', `ERRO: ${error.message}`, 'error');
            } finally {
                showNotificationManager(name);
            }
        }
        
        function renderBot(bot) {
            const isOnline = bot.pm2_env.status === 'online';
            const statusClass = isOnline ? 'status-online' : 'status-offline';
            const memory = (bot.monit.memory / 1024 / 1024).toFixed(1);
            const statusText = isOnline ? 'ATIVO' : bot.pm2_env.status.toUpperCase();

            return `
                <div class="bot-card" data-bot-name="${bot.name}">
                    <div class="card-header">
                        <div class="card-title-group">
                            <h2>${bot.name}</h2>
                            <div class="status-indicator ${statusClass}"><span>${statusText}</span></div>
                        </div>
                        <div class="card-header-actions">
                            <button class="action-btn-icon danger delete-bot-btn" title="Excluir Bot">
                                <i data-feather="trash-2"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="data-field"><span class="label">CARGA DE CPU</span> <span>${bot.monit.cpu}%</span></p>
                        <p class="data-field"><span class="label">USO DE MEMÓRIA</span> <span>${memory} MB</span></p>
                        <p class="data-field"><span class="label">REINICIALIZAÇÕES</span> <span>${bot.pm2_env.restart_time}</span></p>
                    </div>
                    <div class="card-actions">
                        <button class="action-btn-card manage-bot-btn" data-action="start" ${isOnline ? 'disabled' : ''}>Iniciar</button>
                        <button class="action-btn-card manage-bot-btn" data-action="restart" ${!isOnline ? 'disabled' : ''}>Reiniciar</button>
                        <button class="action-btn-card stop manage-bot-btn" data-action="stop" ${!isOnline ? 'disabled' : ''}>Parar</button>
                    </div>
                    <div class="card-footer-actions">
                        <button class="action-btn-footer reset-session-btn" title="Adicionar novo número de WhatsApp"><i data-feather="zap"></i>Add Nº Novo</button>
                        <button class="action-btn-footer manage-notifications-btn" title="Gerir Notificações do Telegram"><i data-feather="bell"></i>Notificações</button>
                        <button class="action-btn-footer upload-env-btn" title="Enviar Ficheiro .env"><i data-feather="upload-cloud"></i>Enviar .env</button>
                        <button class="action-btn-footer show-logs-btn" title="Ver Logs"><i data-feather="terminal"></i>Logs</button>
                        <button class="action-btn-footer update-source-btn" title="Atualizar a partir do Git"><i data-feather="git-pull-request"></i>Atualizar</button>
                    </div>
                </div>
            `;
        }

        function loadBots(bots = []) {
            const botListContainer = document.getElementById('bot-list');
            if (bots && bots.length > 0) {
                botListContainer.innerHTML = bots.map(renderBot).join('');
            } else {
                botListContainer.innerHTML = '<div class="bot-card"><p class="info-message">[NENHUM PROCESSO ENCONTRADO]</p></div>';
            }
            feather.replace();
        }
        
        function connectDashboardSocket() {
            const statusElement = document.getElementById('connection-status');
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/dashboard`;
            
            dashboardSocket = new WebSocket(wsUrl);

            dashboardSocket.onopen = () => { statusElement.textContent = 'Conectado'; statusElement.style.color = 'var(--green)'; };
            dashboardSocket.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    if (message.type === 'statusUpdate') loadBots(message.data);
                    if (message.type === 'progress') {
                        const logContent = document.getElementById('log-content');
                        if (logContent && logContent.closest('.modal-overlay').style.display === 'flex') {
                            logContent.textContent += message.message + '\n';
                            logContent.parentElement.scrollTop = logContent.parentElement.scrollHeight;
                        }
                    }
                } catch (e) { console.error('Failed to parse WebSocket message:', e); }
            };
            dashboardSocket.onclose = () => {
                statusElement.textContent = 'Desconectado. Tentando reconectar...';
                statusElement.style.color = 'var(--red)';
                setTimeout(connectDashboardSocket, 3000);
            };
            dashboardSocket.onerror = (error) => {
                statusElement.textContent = 'Erro de Conexão';
                statusElement.style.color = 'var(--red)';
                console.error('WebSocket Error:', error);
                dashboardSocket.close();
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            const addBotModal = document.getElementById('add-bot-modal');
            const addBotForm = document.getElementById('add-bot-form');
            const botListContainer = document.getElementById('bot-list');
            const notificationListContainer = document.getElementById('notification-list-container');

            // ### CORREÇÃO DO BOTÃO DE FECHAR AQUI ###
            document.body.addEventListener('click', (event) => {
                if (event.target.closest('.close-modal-btn')) {
                    const modal = event.target.closest('.modal-overlay');
                    if (modal) {
                         if (modal.id === 'log-modal' && currentLogSocket) {
                            currentLogSocket.close();
                            currentLogSocket = null;
                        }
                        modal.style.display = 'none';
                    }
                }
            });

            // ### NOVA FUNÇÃO PARA COPIAR O LINK DO TUTORIAL ###
            const copyTutorialBtn = document.getElementById('copy-tutorial-link-btn');
            if (copyTutorialBtn) {
                copyTutorialBtn.addEventListener('click', () => {
                    const tutorialUrl = 'https://habiticongyn.com/tutorial-telegram/';
                    navigator.clipboard.writeText(tutorialUrl).then(() => {
                        const originalContent = copyTutorialBtn.innerHTML;
                        copyTutorialBtn.innerHTML = `
                            <i data-feather="check" style="width: 16px; height: 16px; margin-right: 0.5rem;"></i>
                            <span>Copiado!</span>`;
                        feather.replace();
                        
                        setTimeout(() => {
                            copyTutorialBtn.innerHTML = originalContent;
                            feather.replace();
                        }, 2000);
                    }).catch(err => {
                        console.error('Falha ao copiar o link: ', err);
                        showNotification('Erro', 'Não foi possível copiar o link.', 'error');
                    });
                });
            }
            // ### FIM DA NOVA FUNÇÃO ###

            botListContainer.addEventListener('click', (event) => {
                const button = event.target.closest('button');
                if (!button) return;
                const card = button.closest('.bot-card');
                const botName = card.dataset.botName;

                if (button.classList.contains('manage-bot-btn')) manageBot(botName, button.dataset.action, button);
                if (button.classList.contains('delete-bot-btn')) deleteBot(botName, button);
                if (button.classList.contains('reset-session-btn')) resetBotSession(botName, button);
                if (button.classList.contains('manage-notifications-btn')) showNotificationManager(botName);
                if (button.classList.contains('upload-env-btn')) uploadEnvFile(botName);
                if (button.classList.contains('show-logs-btn')) showLogs(botName);
                if (button.classList.contains('update-source-btn')) showUpdateModal(botName);
            });
            
            notificationListContainer.addEventListener('click', (event) => {
                const button = event.target.closest('button');
                if (!button) return;
                if (button.classList.contains('test-notification-btn')) {
                    const { name, token, chatId } = button.dataset;
                    testNotification(name, token, chatId, button);
                }
                if (button.classList.contains('edit-notification-btn')) {
                    const notificationData = JSON.parse(button.dataset.notification);
                    showEditNotificationModal(notificationData);
                }
                if (button.classList.contains('delete-notification-btn')) {
                    const { notificationId, notificationName } = button.dataset;
                    deleteNotification(notificationId, notificationName, button);
                }
                if (button.closest('.info-message.warning')) {
                    injectNotifierCode(button.closest('.info-message.warning').querySelector('button'));
                }
            });
            
            document.getElementById('edit-notification-form').addEventListener('submit', async (event) => { 
                event.preventDefault(); 
                const submitButton = event.target.querySelector('button[type="submit"]');
                setLoading(submitButton, true, 'Salvando...');

                const notification = { 
                    id: document.getElementById('notification-id').value, 
                    name: document.getElementById('notification-name').value, 
                    purpose: document.getElementById('notification-purpose').value,
                    token: document.getElementById('notification-token').value, 
                    chatId: document.getElementById('notification-chat-id').value 
                }; 
                try { 
                    const result = await fetchWithAuth(`/api/bots/notifications/${currentBotForNotifications.name}`, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ notification: notification }) 
                    }); 
                    document.getElementById('edit-notification-modal').style.display = 'none'; 
                    showNotification('Sucesso', result.message); 
                    showNotificationManager(currentBotForNotifications.name); 
                } catch (error) { 
                    showNotification('Falha ao Salvar', `ERRO: ${error.message}`, 'error'); 
                } finally {
                    setLoading(submitButton, false);
                }
            });

            document.getElementById('add-new-notification-btn').addEventListener('click', () => { showEditNotificationModal(); });
            const toggleTokenBtn = document.getElementById('toggle-token-visibility');
            const tokenInput = document.getElementById('notification-token');
            const iconEye = toggleTokenBtn.querySelector('.icon-eye');
            const iconEyeOff = toggleTokenBtn.querySelector('.icon-eye-off');
            toggleTokenBtn.addEventListener('click', () => {
                const isPassword = tokenInput.type === 'password';
                tokenInput.type = isPassword ? 'text' : 'password';
                iconEye.style.display = isPassword ? 'none' : 'block';
                iconEyeOff.style.display = isPassword ? 'block' : 'none';
            });
            feather.replace();
            connectDashboardSocket();
        });
    </script>

</body>

</html>